# 第一章

## 1.JVM的位置

- jvm是运行在操作系统之上的，并不在硬件之上

## 2.JVM的整体结构

![image-20241211203153272](D:\智能设备开发\jvm\笔记\image-20241211203153272.png)

## 3.JVM的架构模型

Java编译器输入的指令流基本上是一种基于栈的指令集架构，另外一种指令集架构则是基于寄存器的指令集架构。

##### 3.1具体来说:这两种架构之间的区别:

- 基于栈式架构的特点

  > 设计和实现更简单，适用于资源受限的系统。
  >
  > 避开了寄存器的分配难题:使用零地址指令方式分配。
  >
  > 指令流中的指令大部分是零地址指令，其执行过程依赖于操作栈。指令集更小，编译器容易实现。
  >
  > 不需要硬件支持，可移植性更好，更好实现跨平台。

-  基于寄存器架构的特点

  > 典型的应用是x86的二进制指令集:比如传统的PC以及Android的Davlik虚拟机。
  >
  > 指令集架构则完全依赖硬件，可移植性差。
  >
  > 性能优秀和执行更高效。
  >
  > 花费更少的指令去完成一项操作。
  >
  > 在大部分情况下，基于寄存器架构的指令集往往都以一地址指令、二地址指令和三地址指令为主，而基于栈式架构的指令集却是以零地址指令为主。

##### 3.2总结

- 由于跨平台性的设计，Java的指令都是根据栈来设计的。不同平台CPU架构不同，所以不能设计为基于寄存器的。优点是跨平台，指令集小，编译器容易实现，缺点是性能下降，实现同样的功能需要更多的指令。
- 时至今日，尽管嵌入式平台已经不是Java程序的主流运行平台了(准确来说应该是HotSpotVM的宿主环境已经不局限于嵌入式平台了），那么为什么不将架构更换为基于寄存器的架构呢?

注：嵌入式平台是一种资源受限的平台。

- **为什么没有进行更换**

  1. **兼容性问题**

     > Java 的 “一次编写，到处运行” 特性依赖于字节码和虚拟机的架构。如果更换为基于寄存器的架构，现有的字节码指令集与新架构的兼容性会是一个巨大的挑战。因为当前 Java 字节码主要是基于栈的架构设计的，其操作数是从操作数栈中获取和存储的。

  2. **JVM 的实现复杂性**

     > 目前的 JVM 实现（如 HotSpot VM）已经针对基于栈的架构进行了高度优化。它包括了复杂的即时编译（JIT）技术，能够在运行时将字节码编译成本地机器码，并进行各种优化，如方法内联、循环展开等。

  3. **性能提升的不确定性**

     > 虽然基于寄存器的架构在某些情况下可以提供性能优势，例如在处理复杂的算术和逻辑运算时，寄存器可以更快地访问操作数。但是对于 Java 程序来说，性能瓶颈往往不仅仅在于指令的执行效率。

  4. **生态系统和开发工具的适配**

     > 整个 Java 开发生态系统，包括集成开发环境（IDE）、调试工具、性能分析工具等，都是基于当前的 JVM 架构构建的。更换架构后，这些工具需要进行大量的更新和适配。

## 4JVM的生命周期

##### 4.1虚拟机的启动

- Java虚拟机的启动是通过引导类加载器(bootstrap class loader)创建一个初始类(initial class)来完成的，这个类是由虚拟机的具体实现指定的。

##### 4.2虚拟机的执行

- 一个运行中的Java虚拟机有着一个清晰的任务：执行Java程序。
- 程序开始执行时他才运行，程序结束时他就停止。
- 执行一个所谓的Java程序的时候，真真正正地执行的是一个叫做Java虚拟机的进程。

##### 4.3虚拟机的退出

###### 4.3.1有如下的几种情况：

- 程序正常执行结束。
- 程序在执行过程中遇到了异常或错误而异常终止。
- 由于操作系统出现错误而导致Java虚拟机进程终止。
- 某线程调用Runtime类或System类的exit，或Runtime类的halt方法，并且Java安全管理器也允许这次exit或halt操作。
- 除此之外，JNI（Java Native Interface）规范描述了用JNI Invocation API来加载或卸载Java虚拟机时，Java虚拟机的推出情况。

## 5.JVM发展历程

- Sun Classic VM
- Exact VM
- **HotSpot Vm**
- **JRockit VM**
- **IBM J9 VM**



# 第二章

## 内存结构概述

![image-20241211213447167](D:\智能设备开发\jvm\笔记\image-20241211213447167.png)

![image-20241211213633148](D:\智能设备开发\jvm\笔记\image-20241211213633148.png)

注：如果要自己写一个Java虚拟机，我们需要考虑哪些环节？

答：1.类加载子系统 2. 执行引擎（解释器、即时编译器、垃圾回收器）

